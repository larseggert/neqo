name: Check for new fuzzing samples
on:
  workflow_dispatch:
  schedule:
    # Run at 12:00 AM on Sunday.
    - cron: '0 0 * * 0'

concurrency:
  # If "pull_request" is added to triggers above, adjust "group" accordingly.
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  fuzz-corpus:
    name: Check for new fuzzing samples
    runs-on: ubuntu-24.04
    permissions:
      pull-requests: write # Needed to create PRs.
      contents: write # Needed to push branches.

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: true # zizmor: ignore[artipacked] We need to push branches.

      - uses: ./.github/actions/rust
        with:
          version: nightly
          tools: cargo-fuzz
          token: ${{ secrets.GITHUB_TOKEN }}

      - id: nss-version
        run: echo "minimum=$(cat neqo-crypto/min_version.txt)" >> "$GITHUB_OUTPUT"

      - uses: ./.github/actions/nss
        with:
          minimum-version: ${{ steps.nss-version.outputs.minimum }}

      - run: ./test/make-fuzz-corpus.sh

      - name: Create PR for new corpus samples
        # Use a PAT to create the PR so that workflows trigger on it.
        # PRs created with GITHUB_TOKEN don't trigger workflows by design.
        env:
          GH_TOKEN: ${{ secrets.NEQO_CI }}
          SHA: ${{ github.sha }}
        run: |
          # If there are no new corpus samples, exit.
          if [ -z "$(git status --porcelain fuzz/corpus)" ]; then
            echo "No new fuzzing corpus samples generated."
            exit 0
          fi

          # Otherwise, create a PR to add them.
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global url."https://x-access-token:${GH_TOKEN}@github.com/".insteadOf "https://github.com/"
          SHA_SHORT=$(echo "$SHA" | cut -c1-7)
          BRANCH="chore-corpus-samples-$SHA_SHORT"
          MESSAGE="chore: Add new fuzzing corpus samples

          A periodic run of the test suite generated new fuzzing samples. This PR adds them to the fuzzing corpus."
          git checkout -b "$BRANCH"
          git add fuzz/corpus
          git commit -m "$MESSAGE"
          git push --set-upstream origin "$BRANCH"
          gh pr create --fill-verbose
